@model IEnumerable<ModelLayer.Models.ViewModel.ProductOfferZoneViewModel>
@{
    //Layout = null;
}

<style>
    tr.menheding th {
        font-size: 12px;
    }

    table tr {
        font-size: 12px;
    }

        table tr td {
            font-size: 12px;
        }

    .getOne {
        margin-bottom: 12px;
        font-size: 13px;
        color: #C08217;
    }

    .totalcount {
        margin-top: -48px;
    }

    .ui-dialog {
        left: 192px;
    }

    .freeOferName {
        margin-left: 280px;
        color: #90A213;
        margin-left: 311px;
    }

    .ui-dialog .ui-dialog-titlebar-close {
        top: 37% !important;
    }
    /*tr.menhedingloadFree {
        position: absolute;
        top: 35px;
        z-index: -5;
    }*/
    #tblFreeProduct {
        position: relative;
        display: block;
        width: 100%;
    }

    tbody.oferScroll {
        display: block;
        overflow-y: auto;
        height: 200px;
        width: 100%;
        margin-top: 39px;
    }

    .hedFreeProdct {
        width: 100%;
        display: block;
        left: 0px;
        top: 0px;
        position: absolute;
    }

    tr.menhedingloadFree th:nth-of-type(1) {
        width: 570px;
    }

    a.page-number {
        float: left;
    }

    .successnew {
        width: 390px;
    }

    .page-number1 {
        padding: 5px;
        background: rgba(220, 220, 220, 0.3) none repeat scroll 0% 0%;
        font-size: 15px;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        text-align: center;
        display: inline-block;
    }

    #Pager1 {
        margin-top: -12px;
    }

    .menhedingloadFree {
        top: 4px !important;
    }

    #FreeCategoryID {
        width: 24% !important;
    }
    #txtFreeProdName { width: 24% !important;
    }
</style>
<div class="box-content">
    <div class="control-group">
        <div class=" span12">
          
           @Html.DropDownList("FreeCategoryID", null, "Select Category", new { @class = "span12" })
            Product Name
                <input type="text" id="txtFreeProdName" class="span2" />
               <input type="button" value="search" onclick="GetFreeProducts();" class="btn btnOffer" style="width: 78px !important; margin-top: -9px;" />
            
        </div>

        <img id="loader_img2" src="~/Content/img/ajax_loader.gif" style="display: none" height="30" width="30" />
    </div>
    <div class="getOne">
        <b>List of Products</b>
        <b class="freeOferName">Offer Name: @ViewBag.OfferName</b>
    </div>


    <div class="row-fluid ">
        <table id="tblFreeProduct" class="table table-striped table-bordered bootstrap-datatable datatable ">

            <thead class="hedFreeProdct">
                <tr class="menheding menhedingloadFree">
                    <th colspan="5">Image</th>
                    <th colspan="5">Product Name</th>
                </tr>
            </thead>
            <tbody class="oferScroll">
                @{
                    if (Model != null)
                    {
                        List<long> ProdId = Model.Select(p => p.ProductID).Distinct().ToList();
                        string ProdName = "";
                        string ProdImage = "";
                        for (int i = 0; i < ProdId.Count; i++)
                        {
                            //VarientId = Model.Where(x => x.ProductID == ProdId[i]).Select(x => x.ProductVarientID).Distinct().ToList();
                            ProdName = Model.Where(x => x.ProductID == ProdId[i]).Select(x => x.ProductName).FirstOrDefault();
                            ProdImage = Model.Where(x => x.ProductID == ProdId[i]).Select(x => x.ShopImage).FirstOrDefault();
                            var varient = Model.Where(p => p.ProductID == ProdId[i]).Select(p => new
                            {
                                p.ProductVarientID,
                                p.ShopStockID,
                                p.ProductName,
                                p.SizeName,
                                p.ColorName,
                                p.MaterialName,
                                p.DimensionName,
                                p.PackSize,
                                p.MRP,
                                p.RetailerRate

                            }).Distinct().ToList();

                            <tr class="subHed">
                                <td colspan="6" style=" text-align: center;">
                                    <img id="imgProductImage" src="@Url.Content(string.IsNullOrEmpty(ProdImage) ? "/Content/no_image.png" : ProdImage)" style="width: 30px; height:30px;" alt= "eZeelo" />
                                </td>
                                <td colspan="3" class="successnew"><b>@ProdName</b></td>
                            </tr>
                            <tr class="colorHeding">
                                <th class="tablesubth" style="width:9.7%">Color</th>
                                <th class="tablesubth">Size</th>
                                <th class="tablesubth">Dimension</th>
                                <th class="tablesubth">Material</th>
                                <th class="tablesubth">PackSize</th>
                                <th class="tablesubth">MRP</th>
                                <th class="tablesubth">Sale Rate</th>
                                <th class="tablesubth">Apply Offer</th>


                                <th style="width:14%"></th>
                            </tr>

                            for (int k = 0; k < varient.Count; k++)
                            {
                                <tr>
                                    <td class="tablesubth">@varient[k].ColorName</td>
                                    <td class="tablesubth">@varient[k].SizeName</td>
                                    <td class="tablesubth">@varient[k].DimensionName</td>
                                    <td class="tablesubth">@varient[k].MaterialName</td>
                                    <td class="tablesubth">@varient[k].PackSize</td>
                                    <td class="tablesubth">@varient[k].MRP</td>
                                    <td class="tablesubth">@varient[k].RetailerRate</td>
                                    <td><input type="checkbox" class="chkFreeApply" value="@varient[k].ShopStockID" id="chkFree#@varient[k].ShopStockID" onclick="ApplyFreeOfferonProduct(this.id);" /><span class='savemsg' style='color:Green'></span></td>



                                </tr>
                            }
                        }
                    }

                }
            </tbody>
        </table>
    </div>
</div>
<div id="Pager1" style="">
    <div class="wrap">
        <div id="slider1" class="slider">
            <ul>
                @for (int c = 1; c <= @ViewBag.TotalPages; c++)
                {
                    <li><a class="page-number1" href="javascript:void();">@c</a></li>
                }
            </ul>

        </div>

        <div class="controls" style="margin-top:-27px;">
            <a href="#noname" class="prev-slide" style="margin-left:-8px;"><<</a>
            <a href="#noname" class="next-slide" style="float: right; margin-right: 290px;">>></a>
        </div>
    </div>
    <span class="totalcount"><b>Showing @ViewBag.PageSize of @ViewBag.TotalCount enteries</b></span>
</div>


<script type="text/javascript">

    var PageIndex;
    var CheckedCount = 0;

    function GetFreeProducts() {

        $('#loader_img2').show();
        var OfferID = "@ViewBag.OfferID";
        var OfferName = "@ViewBag.OfferName";
        var ShopStockID = "@ViewBag.ShopStockID";
        PageIndex = 1;
        var PageSize = 10;
        var CategoryID = 0;
        var urlFreeProd = '';
        var dataFreeProd = '';
        if ($("select#FreeCategoryID option:selected").val() > 0) {
            CategoryID = $("select#FreeCategoryID option:selected").val();
        }
        var FreeProdName = "";
        FreeProdName = $("#txtFreeProdName").val();
        //alert(FreeProdName);
        @*if (FreeProdName == '') {
            urlFreeProd = '@Url.Action("LoadFreeProducts", "OfferZone")';
            dataFreeProd = { 'OfferID': OfferID, 'OfferName': OfferName, 'PageIndex': PageIndex, 'PageSize': PageSize, 'DiscountInRs': DiscountInRs, 'DiscountInPercent': DiscountInPercent, 'CategoryID': CategoryID }

        }
        else {
            urlFreeProd = '@Url.Action("LoadFreeProductsName", "OfferZone")';
            dataFreeProd = { 'OfferID': OfferID, 'OfferName': OfferName, 'PageIndex': PageIndex, 'PageSize': PageSize, 'DiscountInRs': DiscountInRs, 'DiscountInPercent': DiscountInPercent, 'CategoryID': CategoryID, 'FreeProdName': FreeProdName }
        }*@
        //alert(CategoryID);
        $.ajax({

            url: '@Url.Action("LoadFreeProducts", "OfferZone")',
            data: { 'OfferID': OfferID, 'ShopStockID': ShopStockID, 'PageIndex': PageIndex, 'PageSize': PageSize, 'OfferName': OfferName, 'CheckedCount': CheckedCount, 'CategoryID': CategoryID, 'FreeProdName': FreeProdName },
            type: "POST",
            //url: urlFreeProd,
            //data:dataFreeProd,
            cache: false,
            success: function (data) {

                setTimeout(function () {
                    $("[id*=divPartialFreeProduct]").html(data);
                }, 2000);
                setTimeout(function () {
                    BindSavedOffersToProduct(OfferID);
                }, 2000);
                $('#loader_img2').hide();
            },
            error: function (x, e) {
                alert('Failure');

            }
        });
    }


    $("#Pager1 .page-number1").click(function (e) {
        //$("[id*=divPartialFreeProduct]").html("");
        //$("#tblFreeProduct tr:gt(2)").each(function () {

        //    //to get number of checked checkbox on free product page
        //    if ($(this).closest('tr').find('.chkFreeApply').prop('checked')) {
        //        //alert('in');
        //        CheckedCount++;

        //    }
        //});
        $("[id*=divPartialFreeProduct]").html("");
        $('#Pager1').empty();
        var CategoryID = 0;
        if ($("select#FreeCategoryID option:selected").val() > 0) {
            CategoryID = $("select#FreeCategoryID option:selected").val();
        }
        var componentID = "@ViewBag.CompID";
        var page = parseInt($(this).html());
        PageIndex = page;
        var OfferID = "@ViewBag.OfferID";
        var OfferName = "@ViewBag.OfferName";
        var ShopStockID = "@ViewBag.ShopStockID";
        var PageSize = 10;
        $.ajax({
            url: '@Url.Action("LoadFreeProducts", "OfferZone")',
            data: { 'OfferID': OfferID, 'ShopStockID': ShopStockID, 'PageIndex': page, 'PageSize': PageSize, 'OfferName': OfferName, 'CheckedCount': CheckedCount, 'CategoryID': CategoryID },
            type: "Post",
            cache: false,
            success: function (data) {
                //alert(data);
                //$('#loader_img').hide();
                setTimeout(function () {
                    $("[id*=divPartialFreeProduct]").html(data);
                }, 2000);
                //$("[id*=divPartialFreeProduct]").html(data);
                setTimeout(function () {
                    BindFreeSavedOffersToProduct(OfferID, ShopStockID);
                }, 2000);
            },
            error: function (data) {

            }
        });
    });
    //function to save and delete free offers for product
    function ApplyFreeOfferonProduct(ID) {
        var id = ID.split('#');
        var FreeStockID = id[1];
        var OfferID = "@ViewBag.OfferID";
        var ShopStockID = "@ViewBag.ShopStockID";
        var FreeQty = 0;
        var count = 0;
        var CountChecked = "@ViewBag.CheckedCount";
        //alert(CountChecked);
        if ($("[id='" + ID + "']").prop('checked')) {
            //$("#tblFreeProduct tr:gt(2)").each(function () {

            //    //to get number of checked checkbox on free product page
            //    if ($(this).closest('tr').find('.chkFreeApply').prop('checked')) {

            //        count++;
            //    }
            //});
            //$("#tblOfferList tr:gt(0)").each(function () {

            //    //to get number of checked checkbox on free product page
            //    if ($(this).closest('tr').find('.hdnOfferId').val() == OfferID) {
            //        FreeQty = $(this).closest('tr').find('.FreeOty').html()
            //    }
            //});
            //if (FreeQty > 0) {

            //    count = count + CountChecked;

            //    if (count > FreeQty) {
            //        alert('You can not add this product in this offer. because its exceeding the free quantity limit.');
            //        $("[id='" + ID + "']").removeAttr('checked');
            //        return;
            //    }

            //}
            $.ajax({
                url: '@Url.Action("SaveFreeOffer", "OfferZone")',
                data: { 'ShopStockID': ShopStockID, 'FreeStockID': FreeStockID, 'OfferID': OfferID },
                type: "Post",
                cache: false,
                success: function (data) {
                    var msg = $("[id*='" + ID + "']").closest('tr').find('.savemsg');
                    $(msg).text(data);
                    $(msg).show();
                    setTimeout(function () { $(msg).hide(); }, 5000);
                    $("#tblProduct tr:gt(2)").each(function () {  //to chck the checkbox on product page when we select checkbox on free product page
                        var tableShopStockID = $(this).closest('tr').find('.chkApply').val();
                        if (tableShopStockID == ShopStockID) {
                            $(this).closest('tr').find('.chkApply').attr('checked', true);

                        }
                    });

                },
                error: function (data) {

                }
            });
        }
        else {
            $.ajax({
                url: '@Url.Action("DeleteFreeOffer", "OfferZone")',
                data: { 'ShopStockID': ShopStockID, 'FreeStockID': FreeStockID, 'OfferID': OfferID },
                type: "Post",
                cache: false,
                success: function (data) {
                    var msg = $("[id*='" + ID + "']").closest('tr').find('.savemsg');
                    $(msg).text(data);
                    $(msg).show();
                    setTimeout(function () { $(msg).hide(); }, 5000);
                    $("#tblProduct tr:gt(2)").each(function () {  //to chck the checkbox on product page when we select checkbox on free product page
                        var tableShopStockID = $(this).closest('tr').find('.chkApply').val();
                        if (tableShopStockID == ShopStockID) {
                            $(this).closest('tr').find('.chkApply').attr('checked', false);

                        }
                    });
                    //$('#loader_img').hide();
                },
                error: function (data) {

                }
            });
        }
    }

    function GetFreeQuantity(OfferID) {
        var freeQty = 0;
        var count = 0;
        var IsFreeValid = true;
        return $.ajax({
            url: '@Url.Action("GetFreeQuantity", "OfferZone")',
            data: { 'OfferID': OfferID },
            type: "Post",
            cache: false,
            success: function (data) {
                freeQty = data;
                $("#tblFreeProduct tr:gt(2)").each(function () {
                    //to get number of checked checkbox on free product page
                    if ($(this).closest('tr').find('.chkFreeApply').prop('checked')) {
                        count++;

                    }
                });
                if (count > freeQty) {
                    IsFreeValid = false;


                }

            },
            error: function (data) {

            }
        });
        var Is = IsFreeValid
        return Is;
    }

    function BindFreeSavedOffersToProduct(OfferID, ShopStockID) {
        $.ajax({
            url: '@Url.Action("BindFreeSavedOffersToProduct", "OfferZone")',
            data: { 'OfferID': OfferID, 'ShopStockID': ShopStockID },
            type: "Post",
            cache: false,
            success: function (data) {
                $.each(data, function (index, item) {
                    $("#tblFreeProduct tr:gt(2)").each(function () { //loop through free product table and check the checkbox of product which are saved in database
                        var FreeStockID = $(this).closest('tr').find('.chkFreeApply').val();
                        if (item == FreeStockID) {
                            $(this).closest('tr').find('.chkFreeApply').attr('checked', true);
                        }
                    });
                });

            },
            error: function (data) {

            }
        });
    }
</script>

<script src="~/Content/js/lemmon-slider.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        //alert('OK');
        // slider 1
        $('#slider1').lemmonSlider({
            infinite: false
        });

    });

</script>

