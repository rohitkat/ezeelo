@model IEnumerable<ModelLayer.Models.BulkLog>
@{
    ViewBag.Title = "BulkExcel";
}
<div class="row-fluid" style="margin-top: 10px;margin-left: 10px;">
    <div class="box span12">
        <div class="box-header" data-original-title="">
            <h2><i class="icon-exclamation-sign"></i><span class="break">Bulk Upload</span></h2>
        </div>
        <div class="box-content">
            <h2 style="margin-left:5px;">
                Bulk Upload <span style="float:right; margin-right:15px;"><a href="@System.Configuration.ConfigurationManager.AppSettings["EZEELO_IMG_URL"]content/BulkUploadHelpFile.html">Bulk Upload help file</a></span>
            </h2>
            <div class="paragraph" style="margin-left:5px;">
                <p>
                    Bulk Upload helps Merchants upload large catalogs using a simple Excel Template.
                </p>

            </div>
            <div class="ProUp_three" style="margin-left:5px;">
                Recommended for more than 50 product upload. Export Excel sheet using <b>Export Excel</b> button and Upload products in bulk.
            </div>


            @using (Html.BeginForm("GetExcel", "Bulk", FormMethod.Post))
            {
                <div class="box-content">
                    <table class="table">
                        @*<tr>

                                <th class="span2">Select Shop</th>
                            </tr>*@
                        <tr>
                            <td class="span2" style="font-size:15px;">Select Shop</td>

                            @*<td class="span2"><select id="ddlfranchise" name="ddlfranchise" style="width: 200px" /></td>*@
                            @*<td class="span2"><select id="ddlMerchant" name="ddlMerchant" style="width: 200px" /></td>*@
                            <td class="span2">@Html.DropDownList("ddlMerchant", "")</td>
                            <td>
                                <input type="submit" name="btnExportLicensing" style="width: 140px; height: 28px; border: 1px solid#0044cc;"
                                       value="Export Excel" id="exportLicensing" class="button btn-primary" onclick="return validate();" />
                                <span class="msg" style="color:red"></span>
                            </td>


                        </tr>
                    </table>


                </div>

            }

            @using (Html.BeginForm("Index", "Bulk", FormMethod.Post, new { enctype = "multipart/form-data", id = "frmID" }))
            {

                <input type="file" name="file" id="fileUploadExcel" />
                <input type="submit" value="Upload Excel" class="btn btn-small btn-danger" id="btnUploadSheet" />
                <div id="divValidationMsg" class="validation-summary-errors">
                    <br /><br />
                    @if (TempData["ExcelValidationFailed"] != null)
                    {


                        @Html.Raw(TempData["ExcelValidationFailed"])

                    }

                    @if (TempData["GbProductMsg"] != null)
                    {


                        @Html.Raw(TempData["GbProductMsg"])

                    }

                </div>
                <div id="pageloaddiv"></div>
            }


            <div class="box-content box-hide-content">
                <table class="table table-bordered">
                    <tr>
                        <th>
                            Shop Name
                        </th>
                        <th>
                            @Html.DisplayNameFor(model => model.ExcelSheetName)
                        </th>
                        <th>
                            @Html.DisplayNameFor(model => model.BulkType)
                        </th>
                        <th>
                            @Html.DisplayNameFor(model => model.CreateDate)
                        </th>
                        <th>
                            @Html.DisplayNameFor(model => model.CreateBy)
                        </th>
                        <th>
                            @Html.DisplayNameFor(model => model.NetworkIP)
                        </th>
                        <th>
                            Success Count
                        </th>
                        <th>
                            Failure Count
                        </th>
                        @*<th>
                                @Html.DisplayNameFor(model => model.DeviceType)
                            </th>
                            <th>
                                @Html.DisplayNameFor(model => model.DeviceID)
                            </th>*@
                        <th>Actions</th>
                        <th></th>
                    </tr>

                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>
                                @Html.DisplayFor(modelItem => item.Shop.Name)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.ExcelSheetName)
                            </td>
                            <td>
                                @if (item.BulkType == 1)
                                {
                                    <span>Product Sheet</span>
                                }
                                else
                                {
                                    <span>Stock Sheet</span>
                                }

                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.CreateDate)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.PersonalDetail.FirstName)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.NetworkIP)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.TotalSuccess)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.TotalFail)
                            </td>
                            @*<td>
                                    @Html.DisplayFor(modelItem => item.DeviceType)
                                </td>
                                <td>
                                    @Html.DisplayFor(modelItem => item.DeviceID)
                                </td>*@
                            <td>

                                @Html.ActionLink("Details", "Details", "Bulk", new { bulkLogID = item.ID, bulkType = item.BulkType, }, new { @class = "btn btn-small btn-primary" })

                            </td>
                            <td>
                                @if (item.BulkType == 2)
                                {

                                    @Html.ActionLink("Upload Images", "Details", "Bulk", new { bulkLogID = item.ID, bulkType = item.BulkType, }, new { @class = "btn btn-small btn-primary" })

                                }

                            </td>
                        </tr>
                    }

                </table>
            </div>
        </div>
    </div>
</div>





<script src="~/Scripts/jquery-1.10.2.js"></script>


<style type="text/css">
    #pageloaddiv {
        position: fixed;
        left: 0px;
        top: 0px;
        width: 100%;
        height: 100%;
        z-index: 1000;
        background: url('../Content/Images/ajax_loader.gif') no-repeat center center;
        background-size: 100px;
        display: none;
    }
</style>

<script>


    function validate() {
        //alert('in');
        var shopID = $("select#ddlMerchant option:selected").val();
        if (shopID == 0) {
            $('.msg').text('Please Select Shop Name');
            //$('#divfileUpload').css("display", "none");
            return false;
        }
        else {
            //$('#divfileUpload').css("display", "block");
            return true;
        }
    }
    $(function () {
        $('#fileUploadExcel').change(function () {
            var f = this.files[1]

            $("#divValidationMsg").html("");

            for (var i = 0; i < this.files.length; ++i) {


                var filetype = this.files[i].type;
                //     alert(filetype);
                var ValidImageTypes = ["application/vnd.ms-excel", "application/excel", "application/x-msexcel", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"];

                if ($.inArray(filetype, ValidImageTypes) < 0) {
                    $("#divValidationMsg").html("Invalid File Type. Only .xls or.xlsx file is allowed.");
                    break;
                }
            }

        });

    });

    $(document).ready(function () {

        $("#pageloaddiv").attr("display", "none");
        $("#pageloaddiv").css("display", "none");

        $(".btn").click(function () {
            $("#pageloaddiv").attr("display", "block");
            $("#pageloaddiv").css("display", "block");
        });

    });


    function checkfilesize(fileObj) {

        var iSize = ($(fileObj)[0].files[0].size);
        return iSize;
    }

    $(document).ready(function () {
        $("#btnUploadSheet").click(function () {

            var has_selected_file = $('#fileUploadExcel').val();
            //alert(has_selected_file);
            if (has_selected_file != "") {

                fileObj = $("#fileUploadExcel"); //  document.getElementById('<%= fileUploadExcel.ClientID %>');
                var size = checkfilesize(fileObj);
                //1024 * 1024 * 3  = 3145728
                if (size > 3145728) {
                    $("#pageloaddiv").attr("display", "none");
                    $("#pageloaddiv").css("display", "none");
                    $("#divValidationMsg").html("Allowed file size exceeded. (Max. 3 MB).");
                    return false;
                }
                var isAnyValidatonError = $("#divValidationMsg").html();
                if (isAnyValidatonError.trim().length > 0) {
                    $("#pageloaddiv").attr("display", "none");
                    $("#pageloaddiv").css("display", "none");
                    return false;
                }
                else {


                    $("#pageloaddiv").attr("display", "block");
                    $("#pageloaddiv").css("display", "block");
                    return true;
                }
            }
            else {
                $("#pageloaddiv").attr("display", "none");
                $("#pageloaddiv").css("display", "none");
                $("#divValidationMsg").html("Please select Excel file to be uploaded. Max allowed file size is 3 MB.");
                return false;

            }

        });
    });




    $("select#ddlMerchant").bind('change', function () {
        $('.msg').text('');
        var ShopID = 0;
        // alert(franchiseID);
        if ($("select#ddlMerchant option:selected").val() != "") {
            ShopID = $("select#ddlMerchant option:selected").val();
            var MerchantName = $("select#ddlMerchant option:selected").text();
            // alert(ShopID);
            window.location.href = "/Bulk/Index?ShopID=" + ShopID + "&ShopName=" + MerchantName;
            //window.location.href = "Home/MyActionResult?PostData1=" + PostData1 + "&PostData2=" + PostData2;
            //+ ",FranchiseID=" + franchiseID
        }
        else {
            window.location.href = "/Bulk/Index?ShopID=0&ShopName=''";
        }

        @*$.ajax({
            type: "GET",
            url: '@Url.Action("Index", "Bulk")',
            data: { 'ShopID': ShopID },
            //dataType: "json",
            cache: false,
            success: function (msg) {

            },
            error: function (x, e) {
                alert('Failure');

            }
        });*@
    });
</script>
