@model IEnumerable<ModelLayer.Models.ViewModel.ProductVarientViewModel>

@{
    ViewBag.Title = "DisplayComponent";
}

<style>
    .oferNme {
        margin-left: 400px;
        color: #90A213;
    }

    .lstProdct {
        margin: 5px 0 5px 10px;
        color: #C08217;
    }
</style>

@*<div class="lstProdct">
        <b>List of Products</b>
        <b class="oferNme">Offer Name: @ViewBag.OfferName</b>
    </div>*@


<style>
    th, td {
        padding: 5px;
    }

    th {
        background-color: rgb(248, 248, 248);
    }

    #gridT, #gridT tr {
        border: 1px solid #0D857B;
    }

    #subT, #subT tr {
        border: 1px solid #f3f3f3;
    }

    #subT {
        margin: 0px 0px 0px 10px;
        padding: 5px;
        width: 95%;
    }

        #subT th {
            font-size: 12px;
        }

    .hoverEff {
        cursor: pointer;
    }

        .hoverEff:hover {
            background-color: rgb(248, 242, 242);
        }

    .expand {
        background-image: url(/Content/Images/quicklook-bg.png);
        background-position-x: -22px;
        background-repeat: no-repeat;
    }

    .collapse {
        background-image: url(/Images/pm.png);
        background-position-x: -2px;
        background-repeat: no-repeat;
    }
    /*#report-div table th  {
        text-align: center;
        font-size: 16px;
    }*/
    .tablesubth {
        text-align: center;
        font-size: 11px;
    }

    tr.menheding th {
        text-align: center;
        color: #F0EDEB;
        background-color: #7A7C7F;
        /*width: 507px;*/
    }

        tr.menheding th:nth-of-type(1) {
            width: 930px;
        }

        tr.menheding th:nth-of-type(2) {
            width: 689px;
        }

    tr.menheding {
        position: absolute;
        top: 21px;
        z-index: 72;
    }

    td.successnew {
        text-align: center;
    }

        td.successnew b {
            color: #79621A;
        }

    #report-div {
        max-height: 408px;
        overflow-y: scroll;
        margin-top: 38px;
    }

    #content {
        margin: 8px 0 0 10px !important;
        padding: 0 !important;
        min-height: 0 !important;
    }

    .breadcrumb {
        margin: 0 0 20px 0 !important;
    }

    tr.subHed td {
        background-color: #ECE6DE !important;
    }

    tr.colorHeding th {
        background-color: #B4B6B9;
        text-align: center;
    }

    .value-prodct {
    }

        .value-prodct ul {
            float: left;
            position: relative;
            padding-right: 10px;
        }

            .value-prodct ul:last-child > li:last-child {
                display: none;
            }

    .thirdLi {
        position: absolute;
        right: -12px;
        top: 28%;
    }

    .value-prodct ul li span {
    }

    .plus {
        font-size: 16px;
    }

    .countEntris {
        float: none !important;
    }

    .showpage {
        float: right;
    }

    .wrap {
        background: none;
    }

    .btn_comp {
        background-color: #BF8B46;
        border: 1px solid#BF8B46;
        color: #fff;
        padding: 2px 7px;
    }

    .mehed th.frstTH {
        width: 445px !important;
    }

    .mehed th.scndTH {
        width: 621px !important;
    }
</style>

<div class="control-group">
    @*@Html.DropDownList("CategoryID", "Select Category")*@
    @*<input type="button" value="search" onclick="GetProducts();" class="btn btnOffer" style="margin-top:-10px;" />*@
    <img id="loader_img" src="~/Content/Images/ajax_loader.gif" style="display: none" height="30" width="30" />   
</div>
<div>@Html.ValidationMessage("Error")</div>
<table class="table table-striped table-bordered bootstrap-datatable datatable dataTable" id="DataTables_Table_0" aria-describedby="DataTables_Table_0_info">
    <tr>
        <td>
            <div id="report-div">
                <table class="table table-striped table-bordered bootstrap-datatable datatable" id="tblProduct">

                    <thead>
                        <tr class="menheding mehed">
                            <th colspan="4" class="frstTH">Image</th>
                            <th colspan="3" class="scndTH">Product Name</th>
                        </tr>
                    </thead>
                    @{


                        if (Model != null)
                        {
                            System.Text.StringBuilder sb = new System.Text.StringBuilder();
                            //List<long> VarientId = new List<long>();
                            List<long> ProdId = Model.Select(p => p.ProductID).Distinct().ToList();
                            string ProdName = "";
                            string ProdImage = "";

                            for (int i = 0; i < ProdId.Count; i++)
                            {
                                //VarientId = Model.Where(x => x.ProductID == ProdId[i]).Select(x => x.ProductVarientID).Distinct().ToList();
                                ProdName = Model.Where(x => x.ProductID == ProdId[i]).Select(x => x.ProductName).FirstOrDefault();
                                ProdImage = Model.Where(x => x.ProductID == ProdId[i]).Select(x => x.ShopImage).FirstOrDefault();
                                var varient = Model.Where(p => p.ProductID == ProdId[i]).Select(p => new
                                {
                                    p.ProductVarientID,
                                    p.ProductName,
                                    p.SizeName,
                                    p.ColorName,
                                    p.MaterialName,
                                    p.DimensionName,
                                    p.Total,
                                    p.TotalSaleRate,
                                    p.ShopStockID


                                }).Distinct().ToList();

                                <tr class="subHed">
                                    @*<td>
                                            <a href="#" class="btn-minimize"><i class="halflings-icon white chevron-up"></i></a>
                                        </td>*@
                                    <td colspan="6" style=" text-align: center;">
                                        @*<img id="imgProductImage" src="~/Images/logo.png" style="width: 95px" alt="" />*@
                                        <img id="imgProductImage" src="@Url.Content(string.IsNullOrEmpty(ProdImage) ? "/Content/no_image.png" : ProdImage)" style="width: 30px; height:30px;" alt= "eZeelo" />
                                    </td>
                                    <td colspan="3" class="successnew"><b>@ProdName</b></td>
                                </tr>


                                <tr class="colorHeding">

                                    <th class="tablesubth">Color</th>
                                    <th class="tablesubth">Size</th>
                                    <th class="tablesubth">Dimension</th>
                                    <th class="tablesubth">Material</th>
                                    <th class="tablesubth">MRP</th>
                                    <th class="tablesubth">Sale Rate</th>
                                    <th class="tablesubth">Component Distribution</th>
                                    <th class="tablesubth">Edit Component</th>
                                </tr>


                                for (int k = 0; k < varient.Count; k++)
                                {

                                    var component = Model.Where(p => p.ProductVarientID == varient[k].ProductVarientID).Select(p => p.shopProductComponentList).ToList();
                                    string CompName = "";
                                    decimal CompTotal = 0;
                                    string ComponentTotal = "";
                                    var str = (HtmlString)null;
                                    foreach (var cmp in component)
                                    {
                                        sb.Clear();
                                        sb.Append("<div class='value-prodct'>");
                                        foreach (var c in cmp)
                                        {
                                            if (c.ComponentName == "VAT")
                                            {
                                                CompName = c.ComponentName + "(" + c.PerUnitRateInPer + " %" + ")";
                                            }
                                            else if (c.DependentOnComponentID > 0)
                                            {
                                                if (c.PerUnitRateInPer > 0)
                                                {
                                                    CompName = c.ComponentName + "(" + c.PerUnitRateInPer + " %" + ")";
                                                }
                                                else if (c.PerUnitRateInRs > 0)
                                                {
                                                    CompName = c.ComponentName + "(Rs. " + c.PerUnitRateInRs + ")";
                                                }
                                            }
                                            else
                                            {
                                                CompName = c.ComponentName + "(" + c.ComponentWeight + " " + c.ComponentUnitName + ")";
                                            }
                                            //ComponentName = ComponentName + CompName;
                                            CompTotal = Math.Round(c.ComponentRate, 2);
                                            sb.Append("<ul>");
                                            sb.Append("<li style='border-bottom:1px solid#ccc'>");
                                            sb.Append(CompName);

                                            sb.Append("</li>");
                                            sb.Append("<li>");
                                            sb.Append("Rs." + CompTotal.ToString());
                                            sb.Append("</li>");
                                            sb.Append("<li class='thirdLi'><div class='plus'>+</div></li>");
                                            //sb.Append("+");
                                            sb.Append("</ul>");

                                            ComponentTotal = ComponentTotal + " +" + CompTotal;

                                        }
                                        //ComponentName = ComponentName.TrimEnd(ComponentName[ComponentName.Length - 1]);
                                        sb.Remove(sb.ToString().Length - 1, 1);
                                        sb.Append("</div>");
                                        str = new HtmlString(sb.ToString());
                                        if (ComponentTotal != "")
                                        {
                                            ComponentTotal = ComponentTotal.Remove(0, 1);
                                        }


                                    }
                                    <tr>
                                        @*<td class="tablesubth"><input type="checkbox" class="chkApply" value="@varient[k].ShopStockID" id="chk#@varient[k].ShopStockID" onclick="ApplyOfferonProduct(this.id); " /><span class='savemsg' style='color:Green'></td>*@
                                        <td class="tablesubth">@varient[k].ColorName<input type="hidden" value="@varient[k].ShopStockID" class="hdnShopStockID" /></td>
                                        <td class="tablesubth">@varient[k].SizeName<input type="hidden" value="@varient[k].ProductVarientID" class="hdnProductVarientID" /></td>
                                        <td class="tablesubth">@varient[k].DimensionName</td>
                                        <td class="tablesubth">@varient[k].MaterialName</td>
                                        <td class="tablesubth">@varient[k].TotalSaleRate</td>
                                        <td class="tablesubth">@varient[k].TotalSaleRate</td>
                                        <td class="tablesubth">@Html.Raw(str)</td>
                                        <td><input type="button" value="Edit Component" id="btn#@varient[k].ProductVarientID" class="btn_comp" onclick="EditComponent(this.id)" /></td>

                                    </tr>
                                }

                            }
                        }
                    }


                </table>

            </div>
        </td>
    </tr>
</table>

<div>
    <input type="button" value="Approve" onclick="Approve()" class="btn btn-primary" />
    @Html.ActionLink("Back", "Edit", new { id = ViewBag.ProductID, shopId = ViewBag.ShopID }, new { @class = "btn btn-small btn-danger" })
</div>
<div class="loader">
    <img id="loader_img1" src="~/Content/Images/ajax_loader.gif" style="display: none" height="30" width="30" />
</div>

@*<div>
        <input type="button" value="Back to Product"/>
    </div>*@

<div id="divPartialView">

    @*@Html.Partial("_AddComponent", Model)*@

</div>
<div class="loader">
    <img id="loader_img1" src="~/Content/img/loader.gif" style="display: none" />
</div>
<script>
    function EditComponent(id) {
        $('#loader_img').show();

        var ProductVarientID = $("[id*='" + id + "']").closest('tr').find('.hdnProductVarientID').val();
        var ShopStockID = $("[id*='" + id + "']").closest('tr').find('.hdnShopStockID').val();
        $.ajax({
            url: '@Url.Action("AddComponent", "ProductApproval")',
            data: { 'ShopStockID': ShopStockID, 'ProductVarientID': ProductVarientID },
            type: "Post",
            cache: false,
            success: function (data) {
                $('#divPartialView').html(data);
                $('#loader_img').hide();
            },
            error: function (data) {

            }
        });
    }

    function Approve() {
        $('#loader_img1').show();
        var ShopID = "@ViewBag.ShopID"
        var ProductID = "@ViewBag.ProductID"
        var IsProprietory = "@ViewBag.IsProprietory";
        var Status = "@ViewBag.Status";
        var Msg = "@ViewBag.Msg";
        $.ajax({
            url: '@Url.Action("ApproveProductComponent", "ProductApproval")',
            data: { 'ProductID': ProductID, 'ShopID': ShopID, 'IsProprietory': IsProprietory, 'msg': Msg, 'status': Status },
            type: "Post",
            cache: false,
            success: function (data) {
                //alert(data);
                if (data.ok) {
                    window.location = data.newurl;
                }
                else {
                    window.alert(data.message);
                }
                $('#loader_img1').hide();
            },
            error: function (data) {

            }
        });

    }
</script>