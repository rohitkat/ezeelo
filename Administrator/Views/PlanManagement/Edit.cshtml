@using PagedList.Mvc;
@using PagedList;

@model IPagedList<ModelLayer.Models.Category>

@{
    ViewBag.Title = "Edit";
}

<div>



</div>

<div class="row-fluid">
    <div class="box span12">
        <div class="box-header">
            <h2><i class="icon-edit"></i><span class="break"></span>@Html.ActionLink("Edit", "Create")</h2>

        </div>
        <div class="box span6 gridBox">
            <div class="box-content">
                <div class="form-control span12">
                    <div class="span6">
                        <span>Level One Category</span>
                        @Html.DropDownList("Levelone", "Select Level One")
                    </div>
                    <div class="span6">
                        <span>Level Two Category</span>
                        @Html.DropDownList("LevelTwo", "Select Level Two")
                    </div>
                </div>
                <div id="pageloaddiv"></div>
                <a id="AddAll" href="#"> Add ALL</a>
                <table class="table table-bordered" id="tableSimilarProduct">
                    <thead>

                        <tr>

                            <th>
                                ID
                            </th>
                            <th>
                                Name
                            </th>


                            <th></th>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                        <tr>
                            <td>
                                @Html.DisplayFor(modelItem => item.ID)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.Name)
                            </td>
                            <td>
                                @Html.ActionLink("Edit", "Edit", new { id = item.ID }) |
                            </td>
                        </tr>
                        }
                    </tbody>
                </table>


            </div>
        </div>
        <div class="box span6 gridBox">
            <div class="box-content">
                @using (Html.BeginForm("Edit", "PlanManagement", null, FormMethod.Post))
                {

                    <div class="form-control span12">
                        <div class="span6">
                            <span>Select Master Plan</span>
                            @Html.DropDownList("MasterPlan", "Select Plan")
                        </div>
                        <div class="span6 ddlTOp">
                            @Html.RadioButton("Included", 1, true) Included
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                            @Html.RadioButton("Included", 2) Excluded
                        </div>
                    </div>
                    <div class="span12">
                        <div class="span6">
                            @if (ViewBag.pMessage != null)
                            {
                                @Html.Label("pMessage","")
                            }
                            <span id="pMessage"> </span>
                        </div>
                        <div class="span6">
                            <input id="btnSubmit" type="submit" name="btnSubmit" class="btn btn-success" />
                        </div>
                    </div>
                    <div class="span12 gridBox2">
                        <table class="table table-striped table-bordered" id="thirdLevelCategory">
                            <thead>
                                <tr>
                                    <td>
                                        ID
                                    </td>
                                    <td>
                                        Name
                                    </td>
                                    <th></th>
                                </tr>
                            </thead>
                            @if (ViewBag.PlanBind != null)
                        {
                        <tbody>

                            @for (int i = 0; i < ViewBag.PlanBind.Count; i++)
                                {
                                <script>
                                        $(document).ready(function () {
                                            addCategoryId(@ViewBag.PlanBind[i].CategoryID);
                                        });
                                </script>

                                <tr>
                                    <td>@ViewBag.PlanBind[i].CategoryID</td>
                                    <td>@ViewBag.PlanBind[i].CategoryName</td>
                                    <td> <a href="#noname">Remove</a></td>
                                </tr>
                                }

                        </tbody>
                        }
                        </table>
                    </div>
                    <input type="hidden" name="CaltegoryList" id="CaltegoryList">
                    
                }
            </div>
        </div>
    
    </div><!--/span-->
    <div class="form-actions">
        @Html.ActionLink("Back To List", "Index", null, new { @class = "btn" })
    </div>
</div>

<script src="~/Scripts/jquery-1.10.2.min.js"></script>

<style type="text/css">
    #pageloaddiv {
        position: fixed;
        left: 0px;
        top: 0px;
        width: 100%;
        height: 100%;
        z-index: 1000;
        background: url('../Content/Images/ajax_loader.gif') no-repeat center center;
        background-size: 100px;
        display: none;
    }
</style>

<script type="text/javascript">

    $(document).ready(function () {
        $("#pageloaddiv").css('display', 'none');
        $("#pageloaddiv").fadeOut(1000);
    })

    var CategoryIDList = [];
    var count = 1;
    function addCategoryId(id) {
        CategoryIDList.push(id);
        $("[id*=CaltegoryList]").val(CategoryIDList);
    }
    $(function () {

        $("#btnSubmit").click(function () {
            var selectedVal = $("#MasterPlan option:selected").text();

            if (selectedVal == 'Select Plan') {
                pMessage.textContent = 'Please select the Plan'
                return false;
            }
            else {
                $("#pageloaddiv").attr("display", "block");
                $("#pageloaddiv").css("display", "block");

            }
        });
    });

    $(function () {
        $('#Levelone').change(function (e) {
            var selectedVal = $("#Levelone option:selected").val();
            if (selectedVal > 0) {
                $("#pageloaddiv").attr("display", "block");
                $("#pageloaddiv").css("display", "block");

                $.ajax({
                    type: "POST",
                    url: "/PlanManagement/GetSecondLevelCategory",
                    data: "{ pcatID: '" + selectedVal + "'}",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    async: true,
                    cache: false,
                    success: function (msg) {
                        //alert(response);
                        $('#LevelTwo').empty();
                        $('#LevelTwo').append('<option value=0>Select Category</option>');
                        $.each(msg, function (index, item) {
                            // alert(item.ID);
                            $('#LevelTwo').append('<option value=' + item.ID + '>' + item.Name + '</option>');
                        });
                        $("#pageloaddiv").css('display', 'none');
                        $("#pageloaddiv").fadeOut(1000);
                    },
                    error: function (response) {
                        alert(response);
                        $("#pageloaddiv").css('display', 'none');
                        $("#pageloaddiv").fadeOut(1000);
                    }
                });
            }
        });
    });

    $(function () {
        $('#LevelTwo').change(function (e) {
            var selectedVal = $('#LevelTwo option:selected').val();

            if (selectedVal > 0) {
                $("#pageloaddiv").attr("display", "block");
                $("#pageloaddiv").css("display", "block");

                $.ajax({
                    type: "POST",
                    url: "/PlanManagement/GetSecondLevelCategory",
                    data: "{ pcatID: '" + selectedVal + "'}",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    async: true,
                    cache: false,
                    success: function (msg) {
                        $('#tableSimilarProduct').empty();
                        $("#tableSimilarProduct ").append("<tr>" +
                               "<th>ID</th>" +
                               "<th>Name </th>" +
                               "<th></th> </tr>"
                            );
                        $.each(msg, function (index, item) {
                            $("#tableSimilarProduct ").append("<tr id=" + item.ID + ">" +
                                "<td>" + item.ID + "</td>" +
                                "<td>" + item.Name + "</td>" +
                                 "<td>" + "<a class='btnAdd' onclick='AddRowToTable(" + item.ID + ");'>ADD</a>" +
                                 "</td> </tr>"

                            );
                            count = count + 1;
                        });
                        $("#tableSimilarProduct .btnAdd").click(function () {
                            $(this).parent().parent().css('background-color', '#c4eccc');
                        });
                        $("#pageloaddiv").css('display', 'none');
                        $("#pageloaddiv").fadeOut(1000);
                    },
                    error: function (x, e) {
                        alert("Sorry No Unable to Bind Data. ");
                        $("#pageloaddiv").css('display', 'none');
                        $("#pageloaddiv").fadeOut(1000);
                    }
                });
            }

        });
    });


    function AddRowToTable(id) {

        var tRow = $("[id*=" + id + "]").html();
        $("[id*=thirdLevelCategory]").append("<tr>" + tRow + "</tr>");
        $("#thirdLevelCategory tr td a").replaceWith("<a href='#noname'>Remove</a>");
        CategoryIDList.push(id);
        $("[id*=CaltegoryList]").val(CategoryIDList);

        $("[id*=thirdLevelCategory] tr td a").click(function () {

            $(this).parent().parent().remove();

            var cid = $(this).parent().parent().children("td:first").html();

            CategoryIDList.splice(CategoryIDList.indexOf(parseInt(cid)), 1);

            $("[id*=CaltegoryList]").val(CategoryIDList);

            $("[id*=tableSimilarProduct]").find("#" + cid).css("background-color", "white");
            //alert(CategoryIDList.indexOf(parseInt(cid)));

        });
    }

</script>


<script type="text/javascript">
    $(document).ready(function () {
        $("[id*=thirdLevelCategory] tr td a").click(function () {

            $(this).parent().parent().remove();

            var cid = $(this).parent().parent().children("td:first").html();

            CategoryIDList.splice(CategoryIDList.indexOf(parseInt(cid)), 1);

            $("[id*=CaltegoryList]").val(CategoryIDList);

            //alert(CategoryIDList.indexOf(parseInt(cid)));
            $("#pageloaddiv").attr("display", "block");
            $("#pageloaddiv").css("display", "block");
        });


        $("#AddAll").click(function () {

            var data;
            // var aa = $('#tableSimilarProduct').html();
            //Manage Add or Remove Element from Category table to Plan Tabe
            $("#tableSimilarProduct tr").each(function (i, v) {
                var id = $(this).attr('id');
                //Find the Element in the Added Table which is to be added into the in Plan Talbe
                var tableRowCheck = $("#thirdLevelCategory").find("#" + id).html();
                //Add Row into the variable with required id setting
                var tableRowActual = "<tr id='" + id + "'>" + $("[id*=tableSimilarProduct]").find("#" + id).html() + "</tr>";
                // alert(tableRowActual);
                //check wether element is exists in Plan table which is to be added (add only if the element is not found in the plan table)
                if (typeof (tableRowCheck) == "undefined") {
                    //add to the Plan Table
                    $('#thirdLevelCategory').append(tableRowActual);

                    // $('#thirdLevelCategory').append(aa);
                    $('#thirdLevelCategory tbody th').parent().remove();
                    //Replace ADD button to REMOVE button
                    $("#thirdLevelCategory tr td a").replaceWith("<a href='#noname'>Remove</a>");

                    $("#thirdLevelCategory a").click(function () {
                        $(this).parent().parent().remove();
                        var cid = $(this).parent().parent().children("td:first").html();
                        //Remove element from the array List
                        CategoryIDList.splice(CategoryIDList.indexOf(cid), 1);

                        $("[id*=CaltegoryList]").val(CategoryIDList);
                        //alert(cid);
                        $("[id*=tableSimilarProduct]").find("#" + cid).css("background-color", "white");
                        /*Enable Add Button*/
                        $("#tableSimilarProduct tr td a").css('pointer-events', 'auto');
                        $("#tableSimilarProduct tr td a").css('cursor', 'pointer');

                    });
                }
            });

            //Manage Add or Remove element in Array List 
            var header = Array();
            var id;
            $("#tableSimilarProduct tr").each(function (i, v) {
                id = $(this).attr('id');

                var check = CategoryIDList.indexOf(id)
                //alert(CategoryIDList.indexOf(id));
                if (parseInt(id) > 0 && check < 0) {
                    //insert element in to the array List
                    CategoryIDList.push(id);
                    $("[id*=CaltegoryList]").val(CategoryIDList);

                    //Change color of the Add row in table Chategorytable
                    $("#tableSimilarProduct tr").children('td').parent().css('background-color', '#c4eccc');
                    /*Disable Add Button*/
                    $("#tableSimilarProduct tr td a").css('pointer-events', 'none');
                    $("#tableSimilarProduct tr td a").css('cursor', 'default');
                }

            });

        });
    });
</script>


